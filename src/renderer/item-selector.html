<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: transparent;
      color: #c8d8c8;
      user-select: none;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }
    
    .window-frame {
      position: absolute;
      inset: 2px;
      background: #2b2b2b;
      border: 2px solid #4a4a6a;
      box-shadow: 
        inset -2px -2px 0 #1a1a2e,
        inset 2px 2px 0 #4a4a6a;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      height: 28px;
      background: #1a1a2e;
      border-bottom: 2px solid #4a4a6a;
      color: #c8d8c8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      letter-spacing: 1px;
      position: relative;
      -webkit-app-region: drag;
    }
    
    .close-btn {
      position: absolute;
      right: 6px;
      top: 6px;
      width: 16px;
      height: 16px;
      background: #2b2b2b;
      border: 1px solid #4a4a6a;
      color: #c8d8c8;
      font-size: 14px;
      line-height: 14px;
      text-align: center;
      cursor: pointer;
      -webkit-app-region: no-drag;
    }

    .close-btn:hover {
      background: #4a4a6a;
      color: #fff;
    }
    
    .item-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px;
    }
    
    .item {
      padding: 6px 8px;
      border: 1px solid transparent;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
    
    .item:hover { 
      background: #3a3a4a;
      border: 1px solid #4a4a6a;
      color: #ffffff;
    }
    
    .item-info {
      display: flex;
      flex-direction: column;
    }
    
    .item-name { 
      font-weight: bold; 
      font-size: 14px;
    }
    
    .item-desc { 
      font-size: 12px; 
      color: #8a8a9a; 
      margin-top: 2px;
    }
    
    .item:hover .item-desc {
      color: #a8a8b8;
    }
    
    .item-action { 
      font-size: 10px; 
      padding: 2px 6px; 
      border: 1px solid #4a4a6a;
      background: #1a1a2e;
      color: #a8c8a8;
      margin-left: 8px;
    }
    
    .item:hover .item-action {
      background: #4a4a6a;
      color: #ffffff;
      border-color: #c8d8c8;
    }
    
    .action-buy { color: #f0c040; }
    
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #1a1a2e; }
    ::-webkit-scrollbar-thumb { background: #4a4a6a; }
  </style>
</head>
<body>
  <div class="window-frame">
    <div class="header" id="header">
      <span id="header-text" data-i18n="itemSelector.title">选择物品</span>
      <div class="close-btn" id="close-btn">×</div>
    </div>
    <div class="item-list" id="list">
      <!-- Items will be injected here -->
    </div>
  </div>
  <script>
    const $ = id => document.getElementById(id)
    
    // Close button logic
    $('close-btn').onclick = () => window.close()
    
    let i18nData = {}

    function t(key, params) {
      const keys = key.split('.')
      let v = i18nData
      for (const k of keys) {
        if (v && v[k]) v = v[k]
        else return key
      }
      if (typeof v === 'string' && params) {
        return v.replace(/\{(\w+)\}/g, (_, k) => String(params[k] || `{${k}}`))
      }
      return v || key
    }

    // Initialize i18n
    if (window.electronAPI) {
      window.electronAPI.getI18nData().then(data => {
        i18nData = data
        // Initial text update if needed, though most is dynamic
        $('header-text').textContent = t('itemSelector.title')
      })
      window.electronAPI.onLanguageChange((data) => {
        i18nData = data
        $('header-text').textContent = t('itemSelector.title')
        if (lastSelectorData) {
          renderList(lastSelectorData)
        }
      })
    }

    let lastSelectorData = null;

    window.electronAPI.onShowSelector((data) => {
      lastSelectorData = data;
      renderList(data);
    })

    function renderList(data) {
      // data: { type: 'food'|'clean'|'play', items: [...], mode: 'inventory'|'shop' }
      // map keys to translations: itemSelector.map.food, etc.
      const typeKey = `itemSelector.map.${data.type}`
      const translatedType = t(typeKey)
      // Fallback if translation missing or key equals value (meaning lookup failed)
      const typeText = translatedType !== typeKey ? translatedType : (data.type || 'Item')
      
      $('header-text').textContent = typeText
      
      const list = $('list')
      list.innerHTML = ''
      
      if (data.items.length === 0) {
        list.innerHTML = `<div style="padding:10px;text-align:center;color:#666;font-size:12px">${t('itemSelector.empty')}</div>`
        return
      }
      
      data.items.forEach(item => {
        const div = document.createElement('div')
        div.className = 'item'
        
        const info = document.createElement('div')
        info.className = 'item-info'
        
        const name = document.createElement('span')
        name.className = 'item-name'
        const nameKey = 'items.' + item.id + '.name'
        const localizedName = t(nameKey)
        // Fallback to item.name (backend provided) if translation key is returned
        name.textContent = localizedName !== nameKey ? localizedName : item.name
        
        const desc = document.createElement('span')
        desc.className = 'item-desc'
        if (data.mode === 'shop') {
          desc.textContent = t('itemSelector.price', { price: item.price })
        } else {
          desc.textContent = t('itemSelector.count', { count: item.count || 1 })
        }
        
        info.appendChild(name)
        info.appendChild(desc)
        
        const action = document.createElement('div')
        action.className = 'item-action ' + (data.mode === 'shop' ? 'action-buy' : 'action-use')
        action.textContent = data.mode === 'shop' ? t('itemSelector.buy') : t('itemSelector.use')
        
        div.appendChild(info)
        div.appendChild(action)
        
        div.onclick = () => {
          if (data.mode === 'shop') {
            window.electronAPI.buyItem(item.id)
          } else {
            window.electronAPI.useItem(item.id)
          }
          window.close() 
        }
        
        list.appendChild(div)
      })
    }
    
    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') window.close()
    })
  </script>
</body>
</html>